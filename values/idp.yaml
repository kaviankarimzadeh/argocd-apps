# -----------------------------------------------------------------------------
# DEPLOYMENT
# -----------------------------------------------------------------------------
# Number of replicas. Use 2+ for production with PDB enabled.
# replicaCount: 1

image:
  # Container image repository
  repository: kaviankarimzadeh/idp
  # Image tag - defaults to Chart.appVersion if empty
  # tag: "v0.0.2"
  pullPolicy: Always

# -----------------------------------------------------------------------------
# POD CONFIGURATION
# -----------------------------------------------------------------------------
# Pod annotations
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8080"
  prometheus.io/path: "/metrics"

# -----------------------------------------------------------------------------
# AUTOSCALING
# -----------------------------------------------------------------------------
autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 10
  # Target CPU utilization percentage
  targetCPUUtilizationPercentage: 70
  # Target memory utilization percentage
  targetMemoryUtilizationPercentage: 80

# -----------------------------------------------------------------------------
# RESOURCES
# -----------------------------------------------------------------------------
# Resource requests and limits
# Adjust based on your workload - these are conservative defaults
resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

# -----------------------------------------------------------------------------
# HTTPROUTE (Gateway API - Istio, Envoy Gateway, etc.)
# -----------------------------------------------------------------------------
httpRoute:
  enabled: true
  # Parent gateway references
  parentRefs:
    - name: public-gw
      namespace: kgateway-system
  hostnames:
    - idp.achaemenid.nl
  # Routing rules (optional - defaults to / prefix)
  rules:
    - backendRefs:
        - name: idp-platform
          port: 80

# -----------------------------------------------------------------------------
# NETWORK POLICY
# -----------------------------------------------------------------------------
networkPolicy:
  enabled: false

# -----------------------------------------------------------------------------
# DATABASE - PostgreSQL
# -----------------------------------------------------------------------------
# Option 1: Use bundled PostgreSQL (Bitnami subchart)
postgresql:
  enabled: false

# Option 2: Use external PostgreSQL (when postgresql.enabled=false)
externalDatabase:
  host: "postgresql"
  port: 5432
  database: idp
  # Use existing secret for credentials (recommended)
  existingSecret: "postgresql-creds"
  existingSecretUsernameKey: "idpUsername"
  existingSecretPasswordKey: "userPasswordKey"
  # SSL mode: disable, require, verify-ca, verify-full
  sslMode: "disable"

# -----------------------------------------------------------------------------
# DATABASE MIGRATIONS
# -----------------------------------------------------------------------------
# Run SQL migrations before deploying the application.
# Migrations are embedded in the application image and run as a Helm hook Job.
migrations:
  # Enable database migrations (recommended for production)
  enabled: true

# -----------------------------------------------------------------------------
# SECRETS
# -----------------------------------------------------------------------------
# RECOMMENDED: Use existingSecret for production
# Create secret with: kubectl create secret generic idp-credentials \
#   --from-literal=jwt-secret="$(openssl rand -base64 32)" \
#   --from-literal=ldap-bind-pass="..." \
#   --from-literal=git-token="glpat-..." \
#   --from-literal=nexus-pass="..." \
#   --from-literal=nexus-promote-pass="..." \
#   --from-literal=jira-pass="..." \
#   --from-literal=jira-token="..." \
#   --from-literal=vault-test-token="hvs...." \
#   --from-literal=vault-prod-token="hvs...." \
#   --from-literal=argocd-test-token="..." \
#   --from-literal=argocd-prod-token="..."
existingSecret: "idp-credentials"

# -----------------------------------------------------------------------------
# APPLICATION CONFIGURATION
# -----------------------------------------------------------------------------
config:
  # Server port
  port: 8080
  
  # JWT token expiration (e.g., 4h, 8h, 24h)
  # Shorter is more secure, longer is more convenient
  jwtExpiration: "8h"
  
  # CORS allowed origins
  corsOrigins:
    - "https://idp.achaemendi.nl"

  # ---------------------------------------------------------------------------
  # LDAP Configuration
  # ---------------------------------------------------------------------------
  ldap:
    # LDAP server hostname
    host: "91.98.0.225"
    # LDAP port (389 for LDAP, 636 for LDAPS)
    port: 389
    # Base DN for user searches
    baseDN: "dc=achaemenid,dc=nl"
    # Bind DN (service account)
    bindDN: "cn=admin,dc=achaemenid,dc=nl"
    # Bind password is in secrets.ldapBindPass

  # ---------------------------------------------------------------------------
  # ArgoCD Configuration
  # ---------------------------------------------------------------------------
  argocd:
    # Test instance URL (for DIT/SIT/UAT stages)
    testURL: "http://5.75.245.211:30091/"
    # Production instance URL (for PROD stage)
    # Falls back to testURL if not set
    prodURL: "http://37.27.1.46:30093/"

  # ---------------------------------------------------------------------------
  # Nexus Configuration
  # ---------------------------------------------------------------------------
  nexus:
    # Nexus server URL
    url: "http://138.199.218.25:8081"
    # Repository names
    testRepo: "test"
    prodRepo: "prod"
    # Read-only user for browsing charts
    user: "admin"
    # User with write access for chart promotion
    promoteUser: "admin"

  # ---------------------------------------------------------------------------
  # GitLab Configuration
  # ---------------------------------------------------------------------------
  git:
    # GitLab server URL
    url: "https://gitlab.achaemenid.nl"

  # ---------------------------------------------------------------------------
  # Jira Configuration (for PROD CAB approval)
  # ---------------------------------------------------------------------------
  jira:
    # Jira server URL (leave empty to disable)
    url: "https://jira.example.nl"
    # Jira service account username
    user: "admin"
    # Jira statuses that indicate CAB approval (comma-separated)
    cabApprovedStatuses: "Approved,Ready for Deployment"

  # ---------------------------------------------------------------------------
  # Vault Configuration (for secret path validation)
  # ---------------------------------------------------------------------------
  vault:
    # Test Vault URL (for DIT/SIT/UAT stages)
    testURL: "https://vault.achaemenid.nl"
    # Production Vault URL (for PROD stage)
    prodURL: "https://vault.achaemenid.nl"

# -----------------------------------------------------------------------------
# RBAC CONFIGURATION
# -----------------------------------------------------------------------------
rbac:
  # Use existing ConfigMap (recommended for GitOps)
  existingConfigMap: ""
  # Key in the ConfigMap containing rbac.yaml
  configMapKey: "rbac.yaml"
  
  # Inline RBAC configuration (used if existingConfigMap is empty)
  # See config/rbac.yaml for full documentation
  config: |
    # ==========================================================================
    # IDP RBAC Configuration
    # ==========================================================================
    # This configuration defines:
    # 1. Organizational structure (departments â†’ teams)
    # 2. LDAP group mappings for each team
    # 3. Role assignments per team
    #
    # Roles:
    #   - admin: Full access to all features
    #   - deployer: Can create and update services in DIT
    #   - promoter: Can promote services through stages
    #   - viewer: Read-only access
    # ==========================================================================
    
    departments:
      it:
        description: "IT Department"
        teams:
          cloud:
            description: "cloud team"
            ldapGroups:
              - cn=cloud,ou=groups,dc=achaemenid,dc=nl
            roles:
              - admin
      processing:
        description: "Processing Department - Core banking operations"
        teams:
          proset:
            description: "Proset Team - Settlement processing"
            ldapGroups:
              - cn=proset,ou=groups,dc=achaemenid,dc=nl
            roles:
              - deployer
              - viewer
              - promoter

      channels:
        description: "Channel Department - Customer-facing applications"
        teams:
          setzberg:
            description: "setzberg Team - setzberg banking apps"
            ldapGroups:
              - cn=core,ou=groups,dc=achaemenid,dc=nl
            roles:
              - deployer
              - viewer
              - promoter
          
      operations:
        description: "Operations Department - App Operations"
        teams:
          ops:
            description: "Operations team - Responsible for UAT/PROD approvals and PROD merges"
            ldapGroups:
              - cn=operations,ou=groups,dc=achaemenid,dc=nl
            roles:
              - ops       # Can approve/reject MRs as Operations, can merge PROD
              - viewer    # Read-only access to view applications
    
    # Global admin groups - admin access across ALL teams
    globalAdminGroups:
      - cn=cloud,ou=groups,dc=achaemenid,dc=nl
    
    # Global promoter groups - can promote for any team
    globalPromoterGroups:
      - cn=release-managers,ou=groups,dc=example,dc=com
    
    # Global viewer groups - read-only access to all
    globalViewerGroups:
      - cn=viewers,ou=groups,dc=example,dc=com
    
    settings:
      # If true, users must belong to a configured group to login
      # If false, any LDAP user can login with defaultRole
      strictMode: true
      # Default role for users not matching any team (only if strictMode=false)
      defaultRole: viewer
